
/*
Copyright 2024 Likhin H S

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photo Description</title>
  <link rel="stylesheet" href="css/photo-description.css"> <!-- Link to shared CSS file -->
</head>
<body>

  <!-- Back button -->
  <button id="back-button" class="back-button">&larr;</button>

  <!-- Container for photo preview and description form -->
  <div class="description-container">
    <!-- Image preview -->
    <div id="photo-preview">
      <p>Loading Photo...</p>
    </div>
  
    <!-- Description form -->
    <form id="photo-description-form">
      <div class="form-field">
        <label for="country">Country:</label>
        <select id="country" name="country" required>
          <option value="" disabled selected>Select Country</option>
          <option value="">None</option>
          <option value="AF">Afghanistan</option>
          <option value="AL">Albania</option>
          <option value="DZ">Algeria</option>
          <option value="AD">Andorra</option>
          <option value="AO">Angola</option>
          <option value="AR">Argentina</option>
          <option value="AM">Armenia</option>
          <option value="AU">Australia</option>
          <option value="AT">Austria</option>
          <option value="AZ">Azerbaijan</option>
          <option value="BS">Bahamas</option>
          <option value="BH">Bahrain</option>
          <option value="BD">Bangladesh</option>
          <option value="BB">Barbados</option>
          <option value="BY">Belarus</option>
          <option value="BE">Belgium</option>
          <option value="BZ">Belize</option>
          <option value="BJ">Benin</option>
          <option value="BT">Bhutan</option>
          <option value="BO">Bolivia</option>
          <option value="BA">Bosnia and Herzegovina</option>
          <option value="BW">Botswana</option>
          <option value="BR">Brazil</option>
          <option value="BN">Brunei</option>
          <option value="BG">Bulgaria</option>
          <option value="BF">Burkina Faso</option>
          <option value="BI">Burundi</option>
          <option value="KH">Cambodia</option>
          <option value="CM">Cameroon</option>
          <option value="CA">Canada</option>
          <option value="CV">Cape Verde</option>
          <option value="CF">Central African Republic</option>
          <option value="TD">Chad</option>
          <option value="CL">Chile</option>
          <option value="CN">China</option>
          <option value="CO">Colombia</option>
          <option value="KM">Comoros</option>
          <option value="CG">Congo</option>
          <option value="CR">Costa Rica</option>
          <option value="CI">CÃ´te d'Ivoire</option>
          <option value="HR">Croatia</option>
          <option value="CU">Cuba</option>
          <option value="CY">Cyprus</option>
          <option value="CZ">Czech Republic</option>
          <option value="DK">Denmark</option>
          <option value="DJ">Djibouti</option>
          <option value="DM">Dominica</option>
          <option value="DO">Dominican Republic</option>
          <option value="EC">Ecuador</option>
          <option value="EG">Egypt</option>
          <option value="SV">El Salvador</option>
          <option value="GQ">Equatorial Guinea</option>
          <option value="ER">Eritrea</option>
          <option value="EE">Estonia</option>
          <option value="ET">Ethiopia</option>
          <option value="FJ">Fiji</option>
          <option value="FI">Finland</option>
          <option value="FR">France</option>
          <option value="GA">Gabon</option>
          <option value="GM">Gambia</option>
          <option value="GE">Georgia</option>
          <option value="DE">Germany</option>
          <option value="GH">Ghana</option>
          <option value="GR">Greece</option>
          <option value="GD">Grenada</option>
          <option value="GT">Guatemala</option>
          <option value="GN">Guinea</option>
          <option value="GW">Guinea-Bissau</option>
          <option value="GY">Guyana</option>
          <option value="HT">Haiti</option>
          <option value="HN">Honduras</option>
          <option value="HU">Hungary</option>
          <option value="IS">Iceland</option>
          <option value="IN">India</option>
          <option value="ID">Indonesia</option>
          <option value="IR">Iran</option>
          <option value="IQ">Iraq</option>
          <option value="IE">Ireland</option>
          <option value="IL">Israel</option>
          <option value="IT">Italy</option>
          <option value="JM">Jamaica</option>
          <option value="JP">Japan</option>
          <option value="JO">Jordan</option>
          <option value="KZ">Kazakhstan</option>
          <option value="KE">Kenya</option>
          <option value="KI">Kiribati</option>
          <option value="KP">North Korea</option>
          <option value="KR">South Korea</option>
          <option value="KW">Kuwait</option>
          <option value="KG">Kyrgyzstan</option>
          <option value="LA">Laos</option>
          <option value="LV">Latvia</option>
          <option value="LB">Lebanon</option>
          <option value="LS">Lesotho</option>
          <option value="LR">Liberia</option>
          <option value="LY">Libya</option>
          <option value="LI">Liechtenstein</option>
          <option value="LT">Lithuania</option>
          <option value="LU">Luxembourg</option>
          <option value="MG">Madagascar</option>
          <option value="MW">Malawi</option>
          <option value="MY">Malaysia</option>
          <option value="MV">Maldives</option>
          <option value="ML">Mali</option>
          <option value="MT">Malta</option>
          <option value="MH">Marshall Islands</option>
          <option value="MR">Mauritania</option>
          <option value="MU">Mauritius</option>
          <option value="MX">Mexico</option>
          <option value="FM">Micronesia</option>
          <option value="MD">Moldova</option>
          <option value="MC">Monaco</option>
          <option value="MN">Mongolia</option>
          <option value="ME">Montenegro</option>
          <option value="MA">Morocco</option>
          <option value="MZ">Mozambique</option>
          <option value="MM">Myanmar</option>
          <option value="NA">Namibia</option>
          <option value="NR">Nauru</option>
          <option value="NP">Nepal</option>
          <option value="NL">Netherlands</option>
          <option value="NZ">New Zealand</option>
          <option value="NI">Nicaragua</option>
          <option value="NE">Niger</option>
          <option value="NG">Nigeria</option>
          <option value="NO">Norway</option>
          <option value="OM">Oman</option>
          <option value="PK">Pakistan</option>
          <option value="PW">Palau</option>
          <option value="PS">Palestine</option>
          <option value="PA">Panama</option>
          <option value="PG">Papua New Guinea</option>
          <option value="PY">Paraguay</option>
          <option value="PE">Peru</option>
          <option value="PH">Philippines</option>
          <option value="PL">Poland</option>
          <option value="PT">Portugal</option>
          <option value="QA">Qatar</option>
          <option value="RO">Romania</option>
          <option value="RU">Russia</option>
          <option value="RW">Rwanda</option>
          <option value="WS">Samoa</option>
          <option value="SM">San Marino</option>
          <option value="SA">Saudi Arabia</option>
          <option value="SN">Senegal</option>
          <option value="RS">Serbia</option>
          <option value="SC">Seychelles</option>
          <option value="SL">Sierra Leone</option>
          <option value="SG">Singapore</option>
          <option value="SK">Slovakia</option>
          <option value="SI">Slovenia</option>
          <option value="SB">Solomon Islands</option>
          <option value="SO">Somalia</option>
          <option value="ZA">South Africa</option>
          <option value="ES">Spain</option>
          <option value="LK">Sri Lanka</option>
          <option value="SD">Sudan</option>
          <option value="SR">Suriname</option>
          <option value="SE">Sweden</option>
          <option value="CH">Switzerland</option>
          <option value="SY">Syria</option>
          <option value="TW">Taiwan</option>
          <option value="TJ">Tajikistan</option>
          <option value="TZ">Tanzania</option>
          <option value="TH">Thailand</option>
          <option value="TL">Timor-Leste</option>
          <option value="TG">Togo</option>
          <option value="TO">Tonga</option>
          <option value="TT">Trinidad and Tobago</option>
          <option value="TN">Tunisia</option>
          <option value="TR">Turkey</option>
          <option value="TM">Turkmenistan</option>
          <option value="TV">Tuvalu</option>
          <option value="UG">Uganda</option>
          <option value="UA">Ukraine</option>
          <option value="AE">United Arab Emirates</option>
          <option value="US">United States</option>
          <option value="UY">Uruguay</option>
          <option value="UZ">Uzbekistan</option>
          <option value="VU">Vanuatu</option>
          <option value="VE">Venezuela</option>
          <option value="VN">Vietnam</option>
          <option value="YE">Yemen</option>
          <option value="ZM">Zambia</option>
          <option value="ZW">Zimbabwe</option>
        </select>
      </div>

      <div class="form-field">
        <label for="height">Height (in cm):</label>
        <select id="height" name="height">
          <option value="" disabled selected>Select Height</option>
          <option value="">None</option>
        </select>
      </div>
  
      <div class="form-field">
        <label for="build">Build:</label>
        <select id="build" name="build">
          <option value="" disabled selected>Select Build</option>
          <option value="">None</option>
          <option value="Slim">Slim</option>
          <option value="Athletic">Athletic</option>
          <option value="Muscular">Muscular</option>
          <option value="Curvy">Curvy</option>
          <option value="Average">Average</option>
          <option value="Stocky">Stocky</option>
          <option value="Heavyset">Heavyset</option>
        </select>
      </div>
  
      <div>
        <label for="profession">Profession (Max 15 characters):</label>
        <input type="text" id="profession" name="profession" placeholder="Enter your profession" maxlength="15">
      </div>

      <input type="hidden" id="photo_id" name="photo_id">

      <!-- Submit button -->
      <button type="submit" id="post-button">Post</button>
    </form>
  </div>

  <!-- JavaScript -->
  <script>
    // Back button functionality
    document.getElementById('back-button').addEventListener('click', () => {
      window.history.back(); // Simulate navigation to the previous page
    });
  
    // Retrieve and display the uploaded image
    document.addEventListener('DOMContentLoaded', () => {
      const imageData = localStorage.getItem('editedImage');
      if (imageData) {
        const photoPreview = document.getElementById('photo-preview');
        const imgElement = new Image();
        imgElement.src = imageData;
  
        imgElement.onload = () => {
          imgElement.style.width = "100%";
          imgElement.style.height = "100%";
          imgElement.style.objectFit = "cover";
          imgElement.style.borderRadius = "12px";
          photoPreview.innerHTML = "";
          photoPreview.appendChild(imgElement);
        };

        const photoId = localStorage.getItem('photoId');
        if (photoId) {
          document.getElementById('photo_id').value = photoId;
        }
      } else {
        alert('No image found! Redirecting to upload page.');
        window.location.href = 'upload.html'; // Redirect back if no image
      }
    });
  
    // Handle form submission and send data
    document.getElementById('photo-description-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const country = document.getElementById('country').value;
    const height = document.getElementById('height').value;
    const build = document.getElementById('build').value;
    const profession = document.getElementById('profession').value;
    const photoId = document.getElementById('photo_id').value;
    
    const formData = new FormData();
    formData.append('country', country);
    formData.append('height', height);
    formData.append('build', build);
    formData.append('profession', profession);
    formData.append('photo_id', photoId);
    
    // Get the image data from localStorage
    const imageData = localStorage.getItem('editedImage');
    if (imageData) {
      // Convert the base64 image data to a Blob
      const byteString = atob(imageData.split(',')[1]);
      const mimeString = imageData.split(',')[0].split(':')[1].split(';')[0];
      const ab = new ArrayBuffer(byteString.length);
      const ia = new Uint8Array(ab);
      for (let i = 0; i < byteString.length; i++) {
        ia[i] = byteString.charCodeAt(i);
      }
      const blob = new Blob([ab], { type: mimeString });
      
      // Append the image Blob to the form data
      formData.append('photo', blob, 'photo.png');
      
      // Send the form data to the backend
      try {
        const response = await fetch('http://localhost:3000/upload-photo', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: formData
        });

        if (response.ok) {
          window.location.href = 'profile.html'; // Redirect to Profile page
        } else {
          const errorData = await response.json();
          console.error('Server error:', errorData);
          alert('There was an error posting the photo. Please try again.');
        }
      } catch (error) {
        console.error('Fetch error:', error);
        alert('Error occurred. Please try again.');
      }
    } else {
      alert('No image found! Please upload an image.');
    }
  });

  // Generate options for height from 50 cm to 250 cm
  const heightSelect = document.getElementById("height");

  for (let i = 50; i <= 250; i++) {
    const option = document.createElement("option");
    option.value = i;
    option.textContent = `${i} cm`;
    heightSelect.appendChild(option);
  }
  </script>

</body>
</html>
